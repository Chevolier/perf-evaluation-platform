<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCR XC Perf - 用户分析仪表板</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .popular-list {
            list-style: none;
            padding: 0;
        }
        
        .popular-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .popular-name {
            font-weight: 500;
        }
        
        .popular-count {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 5px;
        }
        
        .activity-item {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-time {
            color: #666;
            font-size: 0.8em;
        }
        
        .activity-type {
            font-weight: 500;
            color: #007bff;
        }
        
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 20px;
        }
        
        .refresh-btn:hover {
            background: #0056b3;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 GCR XC Perf - 用户分析仪表板</h1>
        
        <button class="refresh-btn" onclick="loadAnalytics()">刷新数据</button>
        
        <div id="loading" class="loading" style="display: none;">
            正在加载分析数据...
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="analytics-content" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">0</div>
                    <div class="stat-label">总用户数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-page-views">0</div>
                    <div class="stat-label">页面访问次数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-model-selections">0</div>
                    <div class="stat-label">模型选择次数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-chart-additions">0</div>
                    <div class="stat-label">图表添加次数</div>
                </div>
            </div>
            
            <div class="section">
                <h2>热门模型</h2>
                <ul class="popular-list" id="popular-models">
                    <!-- 动态填充 -->
                </ul>
            </div>
            
            <div class="section">
                <h2>热门运行时</h2>
                <ul class="popular-list" id="popular-runtimes">
                    <!-- 动态填充 -->
                </ul>
            </div>
            
            <div class="section">
                <h2>热门实例类型</h2>
                <ul class="popular-list" id="popular-instances">
                    <!-- 动态填充 -->
                </ul>
            </div>
            
            <div class="section">
                <h2>最近图表添加</h2>
                <div class="activity-list" id="recent-chart-additions">
                    <!-- 动态填充 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get API base path
        function getApiUrl(endpoint) {
            const basePath = window.API_BASE_PATH || '';
            return `${basePath}${endpoint}`;
        }

        // Load analytics data
        async function loadAnalytics() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const contentDiv = document.getElementById('analytics-content');
            
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            contentDiv.style.display = 'none';
            
            try {
                const response = await fetch(getApiUrl('/api/analytics/stats'));
                const data = await response.json();
                
                displayAnalytics(data);
                
                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = '加载分析数据失败: ' + error.message;
            }
        }

        // Display analytics data
        function displayAnalytics(data) {
            // Update stats
            document.getElementById('total-users').textContent = data.total_users;
            document.getElementById('total-page-views').textContent = data.total_page_views;
            document.getElementById('total-model-selections').textContent = data.total_model_selections;
            document.getElementById('total-chart-additions').textContent = data.total_chart_additions;
            
            // Update popular models
            const modelsContainer = document.getElementById('popular-models');
            modelsContainer.innerHTML = '';
            data.popular_models.forEach(([model, count]) => {
                const li = document.createElement('li');
                li.className = 'popular-item';
                li.innerHTML = `
                    <span class="popular-name">${model}</span>
                    <span class="popular-count">${count}</span>
                `;
                modelsContainer.appendChild(li);
            });
            
            // Update popular runtimes
            const runtimesContainer = document.getElementById('popular-runtimes');
            runtimesContainer.innerHTML = '';
            data.popular_runtimes.forEach(([runtime, count]) => {
                const li = document.createElement('li');
                li.className = 'popular-item';
                li.innerHTML = `
                    <span class="popular-name">${runtime}</span>
                    <span class="popular-count">${count}</span>
                `;
                runtimesContainer.appendChild(li);
            });
            
            // Update popular instances
            const instancesContainer = document.getElementById('popular-instances');
            instancesContainer.innerHTML = '';
            data.popular_instances.forEach(([instance, count]) => {
                const li = document.createElement('li');
                li.className = 'popular-item';
                li.innerHTML = `
                    <span class="popular-name">${instance}</span>
                    <span class="popular-count">${count}</span>
                `;
                instancesContainer.appendChild(li);
            });
            
            // Update recent chart additions
            const chartAdditionsContainer = document.getElementById('recent-chart-additions');
            chartAdditionsContainer.innerHTML = '';
            data.recent_chart_additions.forEach(event => {
                const div = document.createElement('div');
                div.className = 'activity-item';
                
                const eventTime = new Date(event.timestamp).toLocaleString('zh-CN');
                const eventData = event.data;
                const modelInfo = eventData ? `${eventData.runtime} / ${eventData.instance_type} / ${eventData.model_name}` : '未知模型';
                
                div.innerHTML = `
                    <div class="activity-time">${eventTime}</div>
                    <div class="activity-type">添加图表: ${modelInfo}</div>
                    ${eventData ? `<div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        输入令牌: ${eventData.input_tokens}, 输出令牌: ${eventData.output_tokens}, 随机令牌: ${eventData.random_tokens}
                    </div>` : ''}
                `;
                chartAdditionsContainer.appendChild(div);
            });
        }

        // Load analytics on page load
        document.addEventListener('DOMContentLoaded', loadAnalytics);
    </script>
</body>
</html>